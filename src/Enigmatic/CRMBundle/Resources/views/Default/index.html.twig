{% extends app.request.isXmlHttpRequest()?"AppBundle::empty.html.twig":'EnigmaticCRMBundle::layout.html.twig' %}

{% block title %}{% trans %}enigmatic.crm.header.titles.home{% endtrans %} - {{ parent() }}{% endblock %}
{% block nav_active %}home{% endblock %}

{% block content %}

    <h1>{% trans %}enigmatic.crm.dashboard.title{% endtrans %}</h1>

    <div class="view">

    <div class="search">
        <form class="speednav" action="" method="post">

            <div class="form_row">
                <label for="date_start">De : </label>
                <input id="date_start" type="text" name="date_start" class="datetimepicker2" value="{% if params['date_start'] %}{{ params['date_start'] | date ('d-m-Y H:i') }}{% endif %}" />
            </div>

            <div class="form_row">
                <label for="date_end">à : </label>
                <input id="date_end" type="text" name="date_end" class="datetimepicker2" value="{% if params['date_end'] %}{{ params['date_end'] | date ('d-m-Y H:i') }}{% endif %}" />
            </div>

            <input class="btn" type="submit" value="Générer" />
        </form>
    </div>

    <table class="table table_striped table_extended" id="">
        <thead>
        <tr>
            <th>Utilisateur</th>
            <th colspan="3">Nombre d'activités</th>
            <th colspan="4">Nombre de comptes asignés</th>
        </tr>
        <tr>
            <th></th>
            <th>Appel</th>
            <th>RDV</th>
            <th>Total</th>
            <th>TOP 100</th>
            <th>TOP 150</th>
            <th>Autre</th>
            <th>Total</th>
        </tr>
        </thead>
        <tbody>

        {% for agency in agencies %}
            <tr class="agency_row">
                <td>{{ agency.getName() }}</td>
                <td colspan="7"></td>
            </tr>
            {% for user in users %}
                {% if user.getAgency() == agency %}
                    <tr class="user_row">
                        <td>
                            <input type="checkbox" class="user_checkbox" value="{{ user.getId() }}" />
                            {{ user.getFirstname() }} {{ user.getName() }}
                        </td>

                        <td>
                            {% set sub_total = 0 %}
                            {% if activities[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\ActivityType::CALL')] is defined %}
                                {{ activities[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\ActivityType::CALL')] }}
                                {% set sub_total = sub_total + activities[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\ActivityType::CALL')] %}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {% if activities[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\ActivityType::RDV')] is defined %}
                                {{ activities[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\ActivityType::RDV')] }}
                                {% set sub_total = sub_total + activities[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\ActivityType::RDV')] %}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {{ sub_total }}
                        </td>

                        <td>
                            {% set sub_total = 0 %}
                            {% if accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::TOP_100')] is defined %}
                                {{ accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::TOP_100')] }}
                                {% set sub_total = sub_total + accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::TOP_100')] %}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {% set sub_total = 0 %}
                            {% if accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::TOP_150')] is defined %}
                                {{ accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::TOP_150')] }}
                                {% set sub_total = sub_total + accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::TOP_150')] %}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {% set sub_total = 0 %}
                            {% if accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::OTHER')] is defined %}
                                {{ accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::OTHER')] }}
                                {% set sub_total = sub_total + accounts_onwers[user.getId()][constant('Enigmatic\\CRMBundle\\Entity\\AgencyAccount::OTHER')] %}
                            {% else %}
                                0
                            {% endif %}
                        </td>
                        <td>
                            {{ sub_total }}
                        </td>

                    </tr>
                {% endif %}
            {% endfor %}
        {% endfor %}

        </tbody>
    </table>

    </div>

{% endblock %}
